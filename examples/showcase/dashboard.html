<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>pgcdc - Live CDC Dashboard</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --border: #2a2d3a;
    --text: #e1e4ed;
    --text-muted: #8b8fa3;
    --accent: #6c63ff;
    --green: #34d399;
    --amber: #fbbf24;
    --red: #f87171;
    --mono: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 24px;
  }
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
  }
  header h1 {
    font-size: 22px;
    font-weight: 600;
    letter-spacing: -0.5px;
  }
  header h1 span { color: var(--accent); }
  .status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text-muted);
  }
  .status .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--red);
  }
  .status.connected .dot { background: var(--green); }
  .stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px 20px;
  }
  .stat-card .label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    margin-bottom: 6px;
  }
  .stat-card .value {
    font-family: var(--mono);
    font-size: 28px;
    font-weight: 700;
  }
  .panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    height: calc(100vh - 220px);
    min-height: 400px;
  }
  @media (max-width: 900px) { .panels { grid-template-columns: 1fr; } }
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .panel-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    flex-shrink: 0;
  }
  .panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 4px;
  }
  .panel-body::-webkit-scrollbar { width: 6px; }
  .panel-body::-webkit-scrollbar-track { background: transparent; }
  .panel-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .event-row {
    display: grid;
    grid-template-columns: 80px 100px 1fr auto;
    gap: 12px;
    align-items: center;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-family: var(--mono);
    animation: fadeIn 0.2s ease-out;
  }
  .event-row:hover { background: rgba(108, 99, 255, 0.05); }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; } }
  .op {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-align: center;
  }
  .op-INSERT { background: rgba(52, 211, 153, 0.15); color: var(--green); }
  .op-UPDATE { background: rgba(251, 191, 36, 0.15); color: var(--amber); }
  .op-DELETE { background: rgba(248, 113, 113, 0.15); color: var(--red); }
  .op-VIEW_RESULT { background: rgba(108, 99, 255, 0.15); color: var(--accent); }
  .channel { color: var(--text-muted); }
  .payload {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--text-muted);
    font-size: 12px;
  }
  .time { color: var(--text-muted); font-size: 12px; text-align: right; }
  .view-row {
    padding: 10px 14px;
    border-radius: 6px;
    font-family: var(--mono);
    font-size: 13px;
    animation: fadeIn 0.2s ease-out;
    margin: 2px 0;
  }
  .view-row:hover { background: rgba(108, 99, 255, 0.05); }
  .view-name { color: var(--accent); font-weight: 600; margin-bottom: 4px; }
  .view-data { color: var(--text-muted); font-size: 12px; white-space: pre-wrap; word-break: break-all; }
  .empty-state {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-muted);
    font-size: 14px;
  }
</style>
</head>
<body>

<header>
  <h1><span>pgcdc</span> Live Dashboard</h1>
  <div class="status" id="status">
    <div class="dot"></div>
    <span id="status-text">Connecting...</span>
  </div>
</header>

<div class="stats">
  <div class="stat-card">
    <div class="label">Total Events</div>
    <div class="value" id="total-count">0</div>
  </div>
  <div class="stat-card">
    <div class="label">Inserts</div>
    <div class="value" id="insert-count">0</div>
  </div>
  <div class="stat-card">
    <div class="label">Updates</div>
    <div class="value" id="update-count">0</div>
  </div>
  <div class="stat-card">
    <div class="label">Last Event</div>
    <div class="value" id="last-time" style="font-size:16px;">--</div>
  </div>
</div>

<div class="panels">
  <div class="panel">
    <div class="panel-header">CDC Events</div>
    <div class="panel-body" id="events">
      <div class="empty-state">Waiting for events...</div>
    </div>
  </div>
  <div class="panel">
    <div class="panel-header">Streaming SQL View Results (order_counts)</div>
    <div class="panel-body" id="views">
      <div class="empty-state">Waiting for view results...</div>
    </div>
  </div>
</div>

<script>
(function() {
  const MAX_ROWS = 200;
  let totalCount = 0, insertCount = 0, updateCount = 0;
  let eventsStarted = false, viewsStarted = false;

  const eventsEl = document.getElementById('events');
  const viewsEl = document.getElementById('views');
  const statusEl = document.getElementById('status');
  const statusText = document.getElementById('status-text');

  function formatTime(ts) {
    try {
      const d = ts ? new Date(ts) : new Date();
      return d.toLocaleTimeString();
    } catch { return new Date().toLocaleTimeString(); }
  }

  function truncate(s, n) { return s.length > n ? s.slice(0, n) + '...' : s; }

  function addEvent(data) {
    if (!eventsStarted) { eventsEl.innerHTML = ''; eventsStarted = true; }

    const op = data.operation || 'UNKNOWN';
    const channel = data.channel || '';
    const ts = data.timestamp || '';
    const payload = data.row ? JSON.stringify(data.row) : '';

    totalCount++;
    if (op === 'INSERT') insertCount++;
    if (op === 'UPDATE') updateCount++;

    document.getElementById('total-count').textContent = totalCount;
    document.getElementById('insert-count').textContent = insertCount;
    document.getElementById('update-count').textContent = updateCount;
    document.getElementById('last-time').textContent = formatTime(ts);

    const row = document.createElement('div');
    row.className = 'event-row';
    row.innerHTML =
      '<span class="op op-' + op + '">' + op + '</span>' +
      '<span class="channel">' + channel.replace('pgcdc:', '') + '</span>' +
      '<span class="payload" title="' + payload.replace(/"/g, '&quot;') + '">' + truncate(payload, 120) + '</span>' +
      '<span class="time">' + formatTime(ts) + '</span>';

    eventsEl.prepend(row);
    while (eventsEl.children.length > MAX_ROWS) eventsEl.lastChild.remove();
  }

  function addViewResult(data) {
    if (!viewsStarted) { viewsEl.innerHTML = ''; viewsStarted = true; }

    const row = data.row || data;
    const channel = (data.channel || '').replace('pgcdc:_view:', '');

    const el = document.createElement('div');
    el.className = 'view-row';
    el.innerHTML =
      '<div class="view-name">' + (channel || 'view') + ' @ ' + formatTime(data.timestamp) + '</div>' +
      '<div class="view-data">' + JSON.stringify(row, null, 2) + '</div>';

    viewsEl.prepend(el);
    while (viewsEl.children.length > MAX_ROWS) viewsEl.lastChild.remove();
  }

  function connect() {
    const es = new EventSource('/events');

    es.onopen = function() {
      statusEl.classList.add('connected');
      statusText.textContent = 'Connected';
    };

    es.onmessage = function(e) {
      try {
        const data = JSON.parse(e.data);
        const ch = data.channel || '';

        if (ch.startsWith('pgcdc:_view:') || data.operation === 'VIEW_RESULT') {
          addViewResult(data);
        } else {
          addEvent(data);
        }
      } catch(err) {
        console.error('Parse error:', err, e.data);
      }
    };

    es.onerror = function() {
      statusEl.classList.remove('connected');
      statusText.textContent = 'Reconnecting...';
    };
  }

  connect();
})();
</script>
</body>
</html>
