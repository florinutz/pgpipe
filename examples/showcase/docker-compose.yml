services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: pgcdc
      POSTGRES_PASSWORD: pgcdc
      POSTGRES_DB: pgcdc
    command: ["postgres", "-c", "wal_level=logical"]
    volumes:
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"
    networks:
      - pgcdc-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pgcdc -d pgcdc"]
      interval: 3s
      timeout: 3s
      retries: 10

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - pgcdc-net
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 3s
      retries: 10

  minio-init:
    image: minio/mc:latest
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 minioadmin minioadmin &&
      mc mb --ignore-existing local/pgcdc-events &&
      echo 'Bucket pgcdc-events created.'
      "
    networks:
      - pgcdc-net

  pgcdc:
    build:
      context: ../..
      dockerfile: Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    ports:
      - "8080:8080"
      - "9092:9092"
      - "9090:9090"
    command:
      - listen
      - --db=postgres://pgcdc:pgcdc@postgres:5432/pgcdc?sslmode=disable
      - --detector=wal
      - --all-tables
      - --adapter=stdout,sse,s3,kafkaserver,view
      - --sse-addr=:8080
      - --s3-bucket=pgcdc-events
      - --s3-endpoint=http://minio:9000
      - --s3-region=us-east-1
      - --s3-access-key-id=minioadmin
      - --s3-secret-access-key=minioadmin
      - --s3-flush-interval=10s
      - --kafkaserver-addr=:9092
      - --view-query=order_counts:SELECT channel, COUNT(*) as total FROM pgcdc_events GROUP BY channel TUMBLING WINDOW 30s
      - --metrics-addr=:9090
    networks:
      - pgcdc-net
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:9090/healthz || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10

  dashboard:
    image: nginx:alpine
    depends_on:
      - pgcdc
    ports:
      - "3000:3000"
    volumes:
      - ./dashboard.html:/usr/share/nginx/html/dashboard.html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - pgcdc-net

  datagen:
    image: postgres:16-alpine
    depends_on:
      pgcdc:
        condition: service_healthy
    volumes:
      - ./datagen.sh:/datagen.sh:ro
    entrypoint: ["/bin/bash", "/datagen.sh"]
    networks:
      - pgcdc-net

  kafka-consumer:
    image: edenhill/kcat:1.7.1
    depends_on:
      pgcdc:
        condition: service_healthy
    entrypoint:
      - kcat
      - -b
      - pgcdc:9092
      - -C
      - -t
      - pgcdc.public.orders
      - -f
      - "Topic %t [%p] at offset %o: key=%k value=%s\n"
      - -o
      - beginning
    restart: on-failure
    networks:
      - pgcdc-net

networks:
  pgcdc-net:
    driver: bridge
